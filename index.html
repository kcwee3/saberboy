<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saberboy Adventure</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Previous styles remain the same */
        .task {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Saberboy Adventure</h1>
        <p>Level: <span id="level">1</span></p>
        <p>Health: <span id="health">10</span>/<span id="max-health">10</span></p>
        <p>Position: <span id="position">1</span></p>
        <p>Tokens: <span id="tokens">0</span></p>
        <p>Dice Available: <span id="dice-available">3</span></p>
        <p>Next Dice in: <span id="next-dice-time">30:00</span></p>
        <div class="board" id="board"></div>
        <button onclick="rollDice()">Roll Dice</button>
        <button onclick="buyDice()">Buy 10 Dice (<span id="dice-cost">10</span> tokens)</button>
        <button onclick="upgradeHealth()">Upgrade Health (10 tokens)</button>
        <button onclick="showLeaderboard()">Show Leaderboard</button>
        <p id="game-status"></p>
        <div class="referral-info">
            <h3>Invite Friends</h3>
            <p>Bot Name: <span id="bot-name">saberboybot</span></p>
            <p>Your Referral Code: <span id="referral-code"></span></p>
            <p>Referrals: <span id="referral-count">0</span></p>
            <p>
                Share this link: <span id="referral-link"></span>
                <button onclick="copyReferralLink()" class="copy-button">Copy Link</button>
            </p>
        </div>
        <div id="tasks-container">
            <h3>Tasks</h3>
            <!-- Tasks will be added here dynamically -->
        </div>
    </div>

    <!-- Previous popups remain the same -->

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const BOARD_SIZE = 10;
        const BOT_NAME = 'saberboybot';

        let player = {
            level: 1,
            health: 10,
            maxHealth: 10,
            position: 0,
            tokens: 0,
            diceAvailable: 3,
            nextDiceTime: Date.now(),
            referralCode: '',
            referralCount: 0,
            diceCost: 10
        };

        let tasks = [
            {id: 1, description: "Join Telegram channel", reward: 50, completed: false, link: "https://t.me/yourchannel"},
            {id: 2, description: "Like Facebook page", reward: 30, completed: false, link: "https://facebook.com/yourpage"},
            {id: 3, description: "Follow on Twitter", reward: 40, completed: false, link: "https://twitter.com/youraccount"}
        ];

        // Previous functions remain the same

        function buyDice() {
            if (player.tokens >= player.diceCost) {
                player.tokens -= player.diceCost;
                player.diceAvailable += 10;
                player.diceCost *= 2;
                updatePlayerStats();
                document.getElementById('game-status').textContent = `Bought 10 dice for ${player.diceCost / 2} tokens!`;
                saveGame();
            } else {
                document.getElementById('game-status').textContent = "Not enough tokens to buy dice.";
            }
        }

        function updatePlayerStats() {
            document.getElementById('level').textContent = player.level;
            document.getElementById('health').textContent = player.health;
            document.getElementById('max-health').textContent = player.maxHealth;
            document.getElementById('position').textContent = player.position + 1;
            document.getElementById('tokens').textContent = player.tokens;
            document.getElementById('dice-available').textContent = player.diceAvailable;
            document.getElementById('dice-cost').textContent = player.diceCost;
            document.getElementById('referral-count').textContent = player.referralCount;
        }

        function updateReferralInfo() {
            document.getElementById('bot-name').textContent = BOT_NAME;
            if (!player.referralCode) {
                player.referralCode = generateReferralCode();
                saveGame();
            }
            document.getElementById('referral-code').textContent = player.referralCode;
            document.getElementById('referral-link').textContent = `https://t.me/${BOT_NAME}?start=${player.referralCode}`;
            document.getElementById('referral-count').textContent = player.referralCount;
        }

        function updateTasks() {
            const tasksContainer = document.getElementById('tasks-container');
            tasksContainer.innerHTML = '<h3>Tasks</h3>';
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task';
                if (task.completed) {
                    taskElement.innerHTML = `<p>${task.description} - Completed</p>`;
                } else {
                    taskElement.innerHTML = `
                        <p>${task.description} - Reward: ${task.reward} tokens</p>
                        <button onclick="completeTask(${task.id})">Complete</button>
                    `;
                }
                tasksContainer.appendChild(taskElement);
            });
        }

        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && !task.completed) {
                window.open(task.link, '_blank');
                // In a real implementation, you would verify task completion here
                task.completed = true;
                player.tokens += task.reward;
                updatePlayerStats();
                updateTasks();
                document.getElementById('game-status').textContent = `Completed task. Gained ${task.reward} tokens.`;
                saveGame();
            }
        }

        function saveGame() {
            localStorage.setItem('saberboyGameState', JSON.stringify(player));
            localStorage.setItem('saberboyTasks', JSON.stringify(tasks));
            tg.sendData(JSON.stringify({
                action: "updateGameState",
                player: player,
                tasks: tasks
            }));
        }

        function loadGame() {
            const savedState = localStorage.getItem('saberboyGameState');
            const savedTasks = localStorage.getItem('saberboyTasks');
            if (savedState) {
                player = JSON.parse(savedState);
                createBoard();
                updatePlayerStats();
                updateReferralInfo();
            } else {
                player.referralCode = generateReferralCode();
                updateReferralInfo();
            }
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
            updateTasks();
        }

        // Initialize the game
        loadGame();
        createBoard();
        updatePlayerStats();
        updateTasks();

        // Start timer update interval
        setInterval(updateTimers, 1000);

        // Request initial game state from the bot
        tg.sendData(JSON.stringify({ action: "getGameState" }));

        // Listen for messages from the bot
        tg.onEvent('message', function(event) {
            const data = JSON.parse(event.data);
            if (data.action === "loadGameState") {
                // Uncomment the following lines if you want to use server-side game state
                // player = data.gameState.player;
                // tasks = data.gameState.tasks;
                // createBoard();
                // updatePlayerStats();
                // updateReferralInfo();
                // updateTasks();
            }
        });
    </script>
</body>
</html>
