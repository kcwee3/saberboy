<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saberboy Adventure</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .game-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .board {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        .space {
            width: 50px;
            height: 50px;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
            position: relative;
        }
        .player {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: red;
            position: absolute;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .referral-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .copy-button {
            display: inline-block;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Saberboy Adventure</h1>
        <p>Level: <span id="level">1</span></p>
        <p>Health: <span id="health">10</span>/<span id="max-health">10</span></p>
        <p>Position: <span id="position">1</span></p>
        <p>Tokens: <span id="tokens">0</span></p>
        <p>Next Dice in: <span id="next-dice-time">30:00</span></p>
        <div class="board" id="board"></div>
        <button onclick="rollDice()">Roll Dice</button>
        <button onclick="upgradeHealth()">Upgrade Health (10 tokens)</button>
        <button onclick="showLeaderboard()">Show Leaderboard</button>
        <p id="game-status"></p>
        <div class="referral-info">
            <h3>Invite Friends</h3>
            <p>Bot Name: <span id="bot-name">saberboybot</span></p>
            <p>Your Referral Code: <span id="referral-code"></span></p>
            <p>
                Share this link: <span id="referral-link"></span>
                <button onclick="copyReferralLink()" class="copy-button">Copy Link</button>
            </p>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="attack-popup">
        <h2>Attack!</h2>
        <p>You've landed on a space with 7!</p>
        <p>Attacked player: <span id="attacked-player"></span></p>
        <p>Player's Health: <span id="attacked-health"></span></p>
        <p>Player's Tokens: <span id="attacked-tokens"></span></p>
        <button onclick="rollForDamage()">Roll for Damage</button>
    </div>

    <div class="popup" id="leaderboard-popup">
        <h2>Leaderboard</h2>
        <ol id="leaderboard-list"></ol>
        <button onclick="closeLeaderboard()">Close</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const BOARD_SIZE = 10;
        const BOT_NAME = 'saberboybot';

        let player = {
            level: 1,
            health: 10,
            maxHealth: 10,
            position: 0,
            tokens: 0,
            nextDiceTime: Date.now(),
            referralCode: ''
        };

        let attackedPlayer = null;

        function createBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let i = 0; i < BOARD_SIZE; i++) {
                const space = document.createElement('div');
                space.className = 'space';
                space.textContent = player.position + i + 1;
                board.appendChild(space);
            }
            updatePlayerPosition();
        }

        function updatePlayerPosition() {
            const spaces = document.querySelectorAll('.space');
            spaces.forEach(space => space.innerHTML = space.textContent);
            const currentSpace = spaces[player.position % BOARD_SIZE];
            const playerToken = document.createElement('div');
            playerToken.className = 'player';
            currentSpace.appendChild(playerToken);
        }

        function rollDice() {
            const now = Date.now();
            if (now < player.nextDiceTime) {
                document.getElementById('game-status').textContent = "Wait for the next dice roll.";
                return;
            }

            const roll = Math.floor(Math.random() * 6) + 1;
            player.position = (player.position + roll) % BOARD_SIZE;
            player.tokens += roll;

            updatePlayerPosition();
            createBoard();
            updatePlayerStats();
            document.getElementById('game-status').textContent = `You rolled a ${roll}. Moved to space ${player.position + 1} and gained ${roll} tokens.`;

            player.nextDiceTime = now + 30 * 60 * 1000;

            if ((player.position + 1) % 7 === 0) {
                initiateAttack();
            }

            saveGame();
        }

        function upgradeHealth() {
            if (player.tokens >= 10) {
                player.tokens -= 10;
                player.maxHealth *= 2;
                player.health = player.maxHealth;
                updatePlayerStats();
                document.getElementById('game-status').textContent = "Health upgraded!";
                saveGame();
            } else {
                document.getElementById('game-status').textContent = "Not enough tokens to upgrade health.";
            }
        }

        function initiateAttack() {
            attackedPlayer = {
                name: "Random Player",
                health: Math.floor(Math.random() * 50) + 50,
                tokens: Math.floor(Math.random() * 1000) + 500
            };

            document.getElementById('attacked-player').textContent = attackedPlayer.name;
            document.getElementById('attacked-health').textContent = attackedPlayer.health;
            document.getElementById('attacked-tokens').textContent = attackedPlayer.tokens;

            document.getElementById('overlay').style.display = 'block';
            document.getElementById('attack-popup').style.display = 'block';
        }

        function rollForDamage() {
            const damageRoll = Math.floor(Math.random() * 6) + 1;
            attackedPlayer.health -= damageRoll;
            
            if (attackedPlayer.health <= 0) {
                const stolenTokens = Math.floor(attackedPlayer.tokens * 0.1);
                player.tokens += stolenTokens;
                document.getElementById('game-status').textContent = `You defeated ${attackedPlayer.name} and stole ${stolenTokens} tokens!`;
            } else {
                document.getElementById('game-status').textContent = `You dealt ${damageRoll} damage to ${attackedPlayer.name}!`;
            }

            document.getElementById('overlay').style.display = 'none';
            document.getElementById('attack-popup').style.display = 'none';

            updatePlayerStats();
            saveGame();
        }

        function updatePlayerStats() {
            document.getElementById('level').textContent = player.level;
            document.getElementById('health').textContent = player.health;
            document.getElementById('max-health').textContent = player.maxHealth;
            document.getElementById('position').textContent = player.position + 1;
            document.getElementById('tokens').textContent = player.tokens;
        }

        function updateTimers() {
            const now = Date.now();
            const timeLeft = Math.max(0, player.nextDiceTime - now);
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            document.getElementById('next-dice-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function generateReferralCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function updateReferralInfo() {
            document.getElementById('bot-name').textContent = BOT_NAME;
            if (!player.referralCode) {
                player.referralCode = generateReferralCode();
                saveGame();
            }
            document.getElementById('referral-code').textContent = player.referralCode;
            document.getElementById('referral-link').textContent = `https://t.me/${BOT_NAME}?start=${player.referralCode}`;
        }

        function copyReferralLink() {
            const referralLink = document.getElementById('referral-link').textContent;
            navigator.clipboard.writeText(referralLink).then(() => {
                alert('Referral link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function showLeaderboard() {
            const leaderboardData = [
                { name: "Player 1", level: 5, tokens: 5000 },
                { name: "Player 2", level: 4, tokens: 4000 },
                { name: "Player 3", level: 3, tokens: 3000 },
                { name: "You", level: player.level, tokens: player.tokens }
            ];

            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            leaderboardData.sort((a, b) => b.tokens - a.tokens).forEach((entry, index) => {
                const li = document.createElement('li');
                li.textContent = `${entry.name} - Level: ${entry.level}, Tokens: ${entry.tokens}`;
                if (entry.name === "You") {
                    li.style.fontWeight = 'bold';
                }
                leaderboardList.appendChild(li);
            });

            document.getElementById('overlay').style.display = 'block';
            document.getElementById('leaderboard-popup').style.display = 'block';
        }

        function closeLeaderboard() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('leaderboard-popup').style.display = 'none';
        }

        function saveGame() {
            localStorage.setItem('saberboyGameState', JSON.stringify(player));
            tg.sendData(JSON.stringify({
                action: "updateGameState",
                player: player
            }));
        }

        function loadGame() {
            const savedState = localStorage.getItem('saberboyGameState');
            if (savedState) {
                player = JSON.parse(savedState);
                createBoard();
                updatePlayerStats();
                updateReferralInfo();
            } else {
                player.referralCode = generateReferralCode();
                updateReferralInfo();
            }
        }

        // Initialize the game
        loadGame();
        createBoard();
        updatePlayerStats();

        // Start timer update interval
        setInterval(updateTimers, 1000);

        // Request initial game state from the bot
        tg.sendData(JSON.stringify({ action: "getGameState" }));

        // Listen for messages from the bot
        tg.onEvent('message', function(event) {
            const data = JSON.parse(event.data);
            if (data.action === "loadGameState") {
                // Uncomment the following lines if you want to use server-side game state
                // player = data.gameState;
                // createBoard();
                // updatePlayerStats();
                // updateReferralInfo();
            }
        });
    </script>
</body>
</html>