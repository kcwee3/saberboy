<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saberboy Adventure</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Previous styles remain the same -->
</head>
<body>
    <!-- Previous HTML structure remains the same -->

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const BOARD_SIZE = 10;
        const BOT_NAME = 'saberboybot';

        let player = {
            level: 1,
            health: 10,
            maxHealth: 10,
            position: 0,
            tokens: 0,
            diceAvailable: 3,
            nextDiceTime: Date.now() + 30 * 60 * 1000,
            referralCode: '',
            referralCount: 0,
            diceCost: 10,
            tokenPriceResetTime: getNextSingaporeReset()
        };

        let tasks = [
            {id: 1, description: "Join Telegram channel", reward: 50, completed: false, link: "https://t.me/yourchannel"},
            {id: 2, description: "Like Facebook page", reward: 30, completed: false, link: "https://facebook.com/yourpage"},
            {id: 3, description: "Follow on Twitter", reward: 40, completed: false, link: "https://twitter.com/youraccount"}
        ];

        function getNextSingaporeReset() {
            const now = new Date();
            const sgTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Singapore' }));
            sgTime.setHours(24, 0, 0, 0);
            return sgTime.getTime();
        }

        // Previous functions (createBoard, updatePlayerPosition) remain the same

        function rollDice() {
            if (player.diceAvailable > 0) {
                const roll = Math.floor(Math.random() * 6) + 1;
                document.getElementById('dice-image').textContent = `ðŸŽ² ${roll}`;
                player.position = (player.position + roll) % BOARD_SIZE;
                player.tokens += roll;
                player.diceAvailable--;

                updatePlayerPosition();
                updatePlayerStats();
                document.getElementById('game-status').textContent = `You rolled a ${roll}. Moved to space ${player.position + 1} and gained ${roll} tokens.`;

                if ((player.position + 1) % 7 === 0) {
                    initiateAttack();
                }

                saveGame();
            } else {
                document.getElementById('game-status').textContent = "No dice available. Wait for the next dice or buy more.";
            }
        }

        function buyDice() {
            if (player.tokens >= player.diceCost) {
                player.tokens -= player.diceCost;
                player.diceAvailable += 10;
                player.diceCost *= 2;
                updatePlayerStats();
                document.getElementById('game-status').textContent = `Bought 10 dice for ${player.diceCost / 2} tokens!`;
                saveGame();
            } else {
                document.getElementById('game-status').textContent = "Not enough tokens to buy dice.";
            }
        }

        // Previous functions (upgradeHealth, initiateAttack) remain the same

        function updatePlayerStats() {
            document.getElementById('level').textContent = player.level;
            document.getElementById('health').textContent = player.health;
            document.getElementById('max-health').textContent = player.maxHealth;
            document.getElementById('position').textContent = player.position + 1;
            document.getElementById('tokens').textContent = player.tokens;
            document.getElementById('dice-available').textContent = player.diceAvailable;
            document.getElementById('dice-cost').textContent = player.diceCost;
            document.getElementById('referral-count').textContent = player.referralCount;
        }

        function updateTimers() {
            const now = Date.now();
            
            // Update dice timer
            if (now >= player.nextDiceTime) {
                player.diceAvailable += 3;
                player.nextDiceTime = now + 30 * 60 * 1000;
                updatePlayerStats();
                saveGame();
            }
            const diceTimeLeft = Math.max(0, player.nextDiceTime - now);
            const diceMinutes = Math.floor(diceTimeLeft / 60000);
            const diceSeconds = Math.floor((diceTimeLeft % 60000) / 1000);
            document.getElementById('next-dice-time').textContent = `${diceMinutes}:${diceSeconds.toString().padStart(2, '0')}`;

            // Update token price reset timer
            if (now >= player.tokenPriceResetTime) {
                player.diceCost = 10;
                player.tokenPriceResetTime = getNextSingaporeReset();
                updatePlayerStats();
                saveGame();
            }
            const resetTimeLeft = Math.max(0, player.tokenPriceResetTime - now);
            const resetHours = Math.floor(resetTimeLeft / 3600000);
            const resetMinutes = Math.floor((resetTimeLeft % 3600000) / 60000);
            const resetSeconds = Math.floor((resetTimeLeft % 60000) / 1000);
            document.getElementById('dice-cost-reset-time').textContent = 
                `${resetHours.toString().padStart(2, '0')}:${resetMinutes.toString().padStart(2, '0')}:${resetSeconds.toString().padStart(2, '0')}`;
        }

        // Previous functions (updateReferralInfo, generateReferralCode, copyReferralLink) remain the same

        function updateTasks() {
            const tasksContainer = document.getElementById('tasks-container');
            tasksContainer.innerHTML = '<h3>Tasks</h3>';
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task';
                if (task.completed) {
                    taskElement.innerHTML = `<p>${task.description} - Completed</p>`;
                } else {
                    taskElement.innerHTML = `
                        <p>${task.description} - Reward: ${task.reward} tokens</p>
                        <button onclick="completeTask(${task.id})">Complete</button>
                    `;
                }
                tasksContainer.appendChild(taskElement);
            });
        }

        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && !task.completed) {
                window.open(task.link, '_blank');
                task.completed = true;
                player.tokens += task.reward;
                updatePlayerStats();
                updateTasks();
                document.getElementById('game-status').textContent = `Completed task. Gained ${task.reward} tokens.`;
                saveGame();
            }
        }

        function saveGame() {
            localStorage.setItem('saberboyGameState', JSON.stringify(player));
            localStorage.setItem('saberboyTasks', JSON.stringify(tasks));
            tg.sendData(JSON.stringify({
                action: "updateGameState",
                player: player,
                tasks: tasks
            }));
        }

        function loadGame() {
            const savedState = localStorage.getItem('saberboyGameState');
            const savedTasks = localStorage.getItem('saberboyTasks');
            if (savedState) {
                player = JSON.parse(savedState);
                updatePlayerStats();
                updatePlayerPosition();
            }
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
            updateReferralInfo();
            updateTasks();
        }

        function resetGame() {
            player = {
                level: 1,
                health: 10,
                maxHealth: 10,
                position: 0,
                tokens: 0,
                diceAvailable: 3,
                nextDiceTime: Date.now() + 30 * 60 * 1000,
                referralCode: player.referralCode,
                referralCount: player.referralCount,
                diceCost: 10,
                tokenPriceResetTime: getNextSingaporeReset()
            };
            tasks.forEach(task => task.completed = false);
            createBoard();
            updatePlayerStats();
            updateTasks();
            document.getElementById('game-status').textContent = "Game reset!";
            saveGame();
        }

        // Initialize the game
        createBoard();
        loadGame();

        // Start timer update interval
        setInterval(updateTimers, 1000);

        // Request initial game state from the bot
        tg.sendData(JSON.stringify({ action: "getGameState" }));

        // Listen for messages from the bot
        tg.onEvent('message', function(event) {
            const data = JSON.parse(event.data);
            if (data.action === "loadGameState") {
                // Uncomment the following lines if you want to use server-side game state
                // player = data.gameState.player;
                // tasks = data.gameState.tasks;
                // updatePlayerStats();
                // updatePlayerPosition();
                // updateReferralInfo();
                // updateTasks();
            }
        });
    </script>
</body>
</html>
