<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saberboy Adventure</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .page {
            display: none;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .active {
            display: block;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
        }
        .nav-buttons button {
            width: 23%;
        }
        .board {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
            height: 200px;
        }
        .space {
            width: 18%;
            height: 28%;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1%;
            position: relative;
            font-size: 14px;
        }
        .saberboy {
            width: 25px;
            height: 25px;
            background-color: red;
            border-radius: 50%;
            position: absolute;
            transition: all 0.5s ease;
        }
        #dice-image {
            font-size: 48px;
            text-align: center;
            margin: 20px 0;
            clear: both;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="home-page" class="page active">
        <h1>Saberboy Adventure</h1>
        <p>Level: <span id="player-level">1</span></p>
        <p>Health: <span id="player-health">10</span>/<span id="player-max-health">10</span></p>
        <p>Tokens: <span id="player-tokens">10</span></p>
        <p>Dice Available: <span id="dice-available">3</span></p>
        <p>Next Dice in: <span id="next-dice-time">30:00</span></p>
        <p>Dice Cost Reset in: <span id="dice-cost-reset-time">24:00:00</span></p>
        <div class="board" id="game-board"></div>
        <div id="dice-image">ðŸŽ²</div>
        <button onclick="rollDice()">Roll Dice</button>
        <button onclick="buyDice()">Buy 10 Dice (<span id="dice-cost">10</span> tokens)</button>
        <button onclick="upgradeHealth()">Upgrade Health (<span id="health-upgrade-cost">10</span> tokens)</button>
        <button onclick="resetGame()">Reset Game</button>
        <p id="game-status"></p>
    </div>

    <div id="referral-page" class="page">
        <h1>Invite Friends</h1>
        <p>Your Referral Code: <span id="referral-code">CODE123</span></p>
        <p>Share this link: <span id="referral-link"></span></p>
    </div>

    <div id="leaderboard-page" class="page">
        <h1>Leaderboard</h1>
        <ol id="leaderboard-list"></ol>
    </div>

    <div id="tasks-page" class="page">
        <h1>Tasks</h1>
        <div id="tasks-list"></div>
    </div>

    <div class="nav-buttons">
        <button onclick="showPage('home-page')">Home</button>
        <button onclick="showPage('referral-page')">Referral</button>
        <button onclick="showPage('leaderboard-page')">Leaderboard</button>
        <button onclick="showPage('tasks-page')">Tasks</button>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="attack-popup">
        <h2>Attack!</h2>
        <p>You've landed on a space with 7!</p>
        <p>Attacked player: <span id="attacked-player"></span></p>
        <p>Player's Health: <span id="attacked-health"></span></p>
        <p>Player's Tokens: <span id="attacked-tokens"></span></p>
        <button onclick="rollForDamage()">Roll for Damage</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let player = {
            id: tg.initDataUnsafe.user.id,
            name: tg.initDataUnsafe.user.first_name,
            level: 1,
            health: 10,
            maxHealth: 10,
            tokens: 10,
            position: 0,
            diceAvailable: 3,
            nextDiceTime: Date.now() + 30 * 60 * 1000,
            healthUpgradeCost: 10,
            totalSteps: 0,
            diceCost: 10,
            diceCostResetTime: getNextSingaporeReset()
        };

        const BOARD_SIZE = 10;
        let board = [];

        let tasks = [
            {id: 1, description: "Join Telegram channel", reward: 50, completed: false, link: "https://t.me/yourchannel"},
            {id: 2, description: "Like Facebook page", reward: 30, completed: false, link: "https://facebook.com/yourpage"},
            {id: 3, description: "Follow on Twitter", reward: 40, completed: false, link: "https://twitter.com/youraccount"}
        ];

        let attackedPlayer = null;

        function getNextSingaporeReset() {
            const now = new Date();
            const singapore = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Singapore"}));
            singapore.setHours(24, 0, 0, 0);
            return singapore.getTime();
        }

        function createBoard() {
            const boardElement = document.getElementById('game-board');
            boardElement.innerHTML = '';
            board = [];
            for (let i = 0; i < BOARD_SIZE; i++) {
                const space = document.createElement('div');
                space.className = 'space';
                space.textContent = player.totalSteps + i + 1;
                boardElement.appendChild(space);
                board.push(space);
            }
            const saberboy = document.createElement('div');
            saberboy.className = 'saberboy';
            boardElement.appendChild(saberboy);
            updatePosition();
        }

        function updatePosition() {
            const saberboy = document.querySelector('.saberboy');
            const targetSpace = board[player.position % BOARD_SIZE];
            const rect = targetSpace.getBoundingClientRect();
            const boardRect = document.querySelector('.board').getBoundingClientRect();
            saberboy.style.left = (rect.left - boardRect.left + (rect.width - saberboy.offsetWidth) / 2) + 'px';
            saberboy.style.top = (rect.top - boardRect.top + (rect.height - saberboy.offsetHeight) / 2) + 'px';
        }

        function rollDice() {
            if (player.diceAvailable > 0) {
                const roll = Math.floor(Math.random() * 6) + 1;
                document.getElementById('dice-image').textContent = `ðŸŽ² ${roll}`;
                player.position = (player.position + roll) % BOARD_SIZE;
                player.totalSteps += roll;
                player.tokens += roll;
                player.diceAvailable--;
                
                createBoard();
                updatePosition();
                updatePlayerStats();
                document.getElementById('game-status').textContent = `You rolled a ${roll}. Moved to space ${player.totalSteps}. Gained ${roll} tokens.`;
                
                if (player.totalSteps % 7 === 0) {
                    initiateAttack();
                } else if (player.totalSteps >= BOARD_SIZE * player.level) {
                    levelUp();
                }
                saveGame();
            } else {
                document.getElementById('game-status').textContent = "No dice available. Wait for the next dice or buy more.";
            }
        }

        function initiateAttack() {
            tg.sendData(JSON.stringify({action: "getRandomPlayer"}));
        }

        function rollForDamage() {
            const damageRoll = Math.floor(Math.random() * 6) + 1;
            tg.sendData(JSON.stringify({action: "attackPlayer", targetId: attackedPlayer.id, damage: damageRoll}));
        }

        function levelUp() {
            player.level++;
            player.totalSteps = 0;
            player.position = 0;
            createBoard();
            document.getElementById('game-status').textContent += ` Congratulations! You've reached Level ${player.level}!`;
            saveGame();
        }

        function buyDice() {
            if (player.tokens >= player.diceCost) {
                player.tokens -= player.diceCost;
                player.diceAvailable += 10;
                player.diceCost *= 2;
                updatePlayerStats();
                document.getElementById('game-status').textContent = `Bought 10 dice for ${player.diceCost / 2} tokens!`;
                saveGame();
            } else {
                document.getElementById('game-status').textContent = "Not enough tokens to buy dice.";
            }
        }

        function upgradeHealth() {
            if (player.tokens >= player.healthUpgradeCost) {
                player.tokens -= player.healthUpgradeCost;
                player.maxHealth *= 2;
                player.health = player.maxHealth;
                player.healthUpgradeCost *= 2;
                updatePlayerStats();
                document.getElementById('game-status').textContent = "Health upgraded!";
                saveGame();
            } else {
                document.getElementById('game-status').textContent = "Not enough tokens to upgrade health.";
            }
        }

        function resetGame() {
            player = {
                id: tg.initDataUnsafe.user.id,
                name: tg.initDataUnsafe.user.first_name,
                level: 1,
                health: 10,
                maxHealth: 10,
                tokens: 10,
                position: 0,
                diceAvailable: 3,
                nextDiceTime: Date.now() + 30 * 60 * 1000,
                healthUpgradeCost: 10,
                totalSteps: 0,
                diceCost: 10,
                diceCostResetTime: getNextSingaporeReset()
            };
            tasks.forEach(task => task.completed = false);
            createBoard();
            updatePlayerStats();
            document.getElementById('game-status').textContent = "Game reset!";
            saveGame();
        }

        function updatePlayerStats() {
            document.getElementById('player-level').textContent = player.level;
            document.getElementById('player-health').textContent = player.health;
            document.getElementById('player-max-health').textContent = player.maxHealth;
            document.getElementById('player-tokens').textContent = player.tokens;
            document.getElementById('dice-available').textContent = player.diceAvailable;
            document.getElementById('health-upgrade-cost').textContent = player.healthUpgradeCost;
            document.getElementById('dice-cost').textContent = player.diceCost;
        }

        function updateTimers() {
            const now = Date.now();

            // Update dice timer
            if (now >= player.nextDiceTime) {
                player.diceAvailable += 3;
                player.nextDiceTime = now + 30 * 60 * 1000;
                updatePlayerStats();
                saveGame();
            }
            let timeLeft = Math.max(0, player.nextDiceTime - now);
            let minutes = Math.floor(timeLeft / 60000);
            let seconds = Math.floor((timeLeft % 60000) / 1000);
            document.getElementById('next-dice-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Update dice cost reset timer
            if (now >= player.diceCostResetTime) {
                player.diceCost = 10;
                player.diceCostResetTime = getNextSingaporeReset();
                updatePlayerStats();
                saveGame();
            }
            timeLeft = Math.max(0, player.diceCostResetTime - now);
            let hours = Math.floor(timeLeft / 3600000);
            minutes = Math.floor((timeLeft % 3600000) / 60000);
            seconds = Math.floor((timeLeft % 60000) / 1000);
            document.getElementById('dice-cost-reset-time').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId === 'leaderboard-page') updateLeaderboard();
            if (pageId === 'tasks-page') updateTasks();
        }

        function updateLeaderboard() {
            tg.sendData(JSON.stringify({action: "getLeaderboard"}));
        }

        function updateTasks() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            tasks.forEach(task => {
                const div = document.createElement('div');
                if (task.completed) {
                    div.innerHTML = `<p>${task.description} - Completed</p>`;
                } else }
div.innerHTML = `
                        <p>${task.description} - Reward: ${task.reward} tokens</p>
                        <button onclick="completeTask(${task.id})">Complete</button>
                    `;
                }
                list.appendChild(div);
            });
        }

        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && !task.completed) {
                window.open(task.link, '_blank');
                // In a real implementation, you would verify task completion here
                task.completed = true;
                player.tokens += task.reward;
                updatePlayerStats();
                updateTasks();
                document.getElementById('game-status').textContent = `Completed task. Gained ${task.reward} tokens.`;
                saveGame();
            }
        }

        function updateReferralInfo() {
            const botUsername = 'saberboybot';
            const referralCode = document.getElementById('referral-code').textContent;
            document.getElementById('referral-link').textContent = `https://t.me/${botUsername}?start=${referralCode}`;
        }

        function saveGame() {
            tg.sendData(JSON.stringify({action: "saveGame", player: player, tasks: tasks}));
        }

        function loadGame() {
            tg.sendData(JSON.stringify({action: "loadGame"}));
        }

        // Handle messages from the Telegram bot
        tg.onEvent('message', function(event) {
            const data = JSON.parse(event.data);
            switch (data.action) {
                case "gameLoaded":
                    player = data.player;
                    tasks = data.tasks;
                    updatePlayerStats();
                    createBoard();
                    updateTasks();
                    break;
                case "randomPlayerFound":
                    attackedPlayer = data.targetPlayer;
                    document.getElementById('attacked-player').textContent = attackedPlayer.name;
                    document.getElementById('attacked-health').textContent = attackedPlayer.health;
                    document.getElementById('attacked-tokens').textContent = attackedPlayer.tokens;
                    document.getElementById('overlay').style.display = 'block';
                    document.getElementById('attack-popup').style.display = 'block';
                    break;
                case "attackResult":
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('attack-popup').style.display = 'none';
                    if (data.success) {
                        player.tokens += data.stolenTokens;
                        document.getElementById('game-status').textContent = `Successfully attacked ${attackedPlayer.name} and stole ${data.stolenTokens} tokens!`;
                    } else {
                        document.getElementById('game-status').textContent = `Attack on ${attackedPlayer.name} failed.`;
                    }
                    updatePlayerStats();
                    break;
                case "leaderboardUpdated":
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    data.leaderboard.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.textContent = `${index + 1}. ${entry.name} - Level: ${entry.level}, Tokens: ${entry.tokens}`;
                        if (entry.id === player.id) {
                            li.style.fontWeight = 'bold';
                        }
                        leaderboardList.appendChild(li);
                    });
                    break;
            }
        });

        // Initialize
        loadGame();
        updateReferralInfo();
        setInterval(updateTimers, 1000);
    </script>
</body>
</html>